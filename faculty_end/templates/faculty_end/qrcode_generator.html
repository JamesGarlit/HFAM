{% extends 'faculty_end/base.html' %}
{% load static %}
{% block content %}

<!-- Page header -->
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    QR Code Generator
                </h2>
            </div>
        </div>
    </div>
</div>
<!-- Page body -->
<div class="page-body">
    <div class="container-xl">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Generate Your QR Code</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col d-flex justify-content-center">
                        <div class="border m-2" id="qrcode"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col text-center">
                        <button class="btn btn-sm btn-primary m-1" onclick="generateQRCode()" id="generateBtn">Generate QR Code</button>
                        <button class="btn btn-sm btn-primary m-1" id="downloadBtn" onclick="downloadQRCode()" disabled>Download QR Code</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% block css %}
<!-- Include external CSS stylesheets -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<!-- Additional CSS for the specific page -->
<style>
    /* Your specific page CSS styles */
</style>
{% endblock %}

{% block javascript %}
<!-- Include external JavaScript libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

<!-- Additional JavaScript for the specific page -->
<script>
    {% comment %} Alert Message Scripts {% endcomment %}
    $(document).ready(function () {
        {% if messages %}
        {% for message in messages %}
        {% if message.tags == 'success' %}
        toastr.success('{{ message }}');
        {% elif message.tags == 'error' %}
        toastr.error('{{ message }}');
        {% else %}
        toastr('{{ message }}');
        {% endif %}
        {% endfor %}
        {% endif %}
    });

    // Function to check if a QR code should be displayed
    function shouldDisplayQRCode() {
        const storedData = localStorage.getItem('generatedQRCode');
        return storedData && new Date(storedData).getDate() === new Date().getDate();
    }

    function generateQRCode() {
        const currentDate = new Date();
        const day = currentDate.getDate().toString().padStart(2, '0');
        const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
        const year = currentDate.getFullYear();
        
        const today = `${year}-${month}-${day}`;
        // Check if a QR code should be displayed
        if (!shouldDisplayQRCode()) {
            const currentDate = new Date();
            localStorage.setItem('generatedQRCode', currentDate.toString());
        }

        // Extract first name and last name from the user object (replace with your actual user object)
        const firstName = '{{ user.user_firstname }}';
        const lastName = '{{ user.user_lastname }}';

        const qrText = `${firstName} ${lastName} | ${today}`;

        // Clear previous QR code
        document.getElementById('qrcode').innerHTML = '';

        // Generate new QR code with white border
        const qrcode = new QRCode(document.getElementById('qrcode'), {
            text: qrText,
            width: 400,
            height: 400,
            colorDark: "#000000",  // Dark color of QR code
            colorLight: "#ffffff", // Light color of QR code (white border)
            correctLevel: QRCode.CorrectLevel.H
        });

        // Enable download button
        document.getElementById('downloadBtn').disabled = false;

        // Disable generate button
        document.getElementById('generateBtn').disabled = true;
    }

    function downloadQRCode() {
        // Get the canvas element generated by qrcode.min.js
        const canvas = document.getElementById('qrcode').querySelector('canvas');

        // Create a temporary link element
        const downloadLink = document.createElement('a');

        // Convert the canvas to a data URL
        const dataUrl = canvas.toDataURL('image/png');

        // Extract first name and last name from the user object (replace with your actual user object)
        const firstName = '{{ user.user_firstname }}';
        const lastName = '{{ user.user_lastname }}';

        // Get the current date
        const currentDate = new Date();
        const formattedDate = currentDate.toLocaleDateString('en-PH', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '');

        // Create the file name
        const fileName = `${firstName}${lastName}_${formattedDate}.png`;

        // Set the data URL as the href attribute
        downloadLink.href = dataUrl;
        downloadLink.download = fileName;

        // Append the link to the body and trigger the download
        document.body.appendChild(downloadLink);
        downloadLink.click();

        // Remove the link from the body
        document.body.removeChild(downloadLink);
    }

    // Check if a QR code should be displayed on page load
    if (shouldDisplayQRCode()) {
        generateQRCode();
    }
</script>
{% endblock %}
{% endblock %}