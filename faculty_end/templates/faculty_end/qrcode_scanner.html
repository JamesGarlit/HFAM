{% extends 'faculty_end/base.html' %}
{% load static %}
{% block content %}

<!-- Page header -->
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    QR Code Scanner
                </h2>
            </div>
        </div>
    </div>
</div>
<!-- Page body -->
<div class="page-body">
    <div class="container-xl">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Scan Your QR Code</h3>
            </div>
            <div class="card-body">
                <div class="row justify-content-center">
                    <div class="col-lg-5 col-md-5 col-sm-12">
                        <div class="card">
                            <div class="m-1 embed-responsive embed-responsive-16by9">
                                <video id="scanner" class="embed-responsive-item w-100" playsinline></video>
                            </div>
                        </div>

                        <div class="mb-1">
                            <form id="locationForm" method="post" action="">
                                {% csrf_token %}
                                <div class="form-floating mb-1">
                                    <input name="location" type="text" class="form-control" id="location" value="" readonly>
                                    <label for="location">Location</label>
                                </div>
                                <div class="form-floating mb-1">
                                    <input name="latitude" type="text" class="form-control" id="latitude" value="" readonly>
                                    <label for="latitude">Latitude</label>
                                </div>
                                <div class="form-floating mb-1">
                                    <input name="longitude" type="text" class="form-control" id="longitude" value="" readonly>
                                    <label for="longitude">Longitude</label>
                                </div>
                                <div class="form-floating mb-1">
                                    <input name="date" type="date" class="form-control" id="date" value="" readonly>
                                    <label for="date">Date</label>
                                </div>
                                <div class="form-floating mb-1">
                                    <input name="time_in" type="text" class="form-control" id="time_in" value="" readonly>
                                    <label for="time">Time</label>
                                </div>
                                <div class="form-floating">
                                    <select class="form-select" id="floatingSelect" aria-label="Floating label select example">
                                      <option selected>Click this to select</option>
                                      <option value="Time In">Time In</option>
                                      <option value="Time Out">Time Out</option>
                                    </select>
                                    <label for="floatingSelect">Time In/Time Out</label>
                                  </div>
                                <input type="hidden" id="qrCode" name="qrCode" value="">
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% block css %}
<!-- Include external CSS stylesheets -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<!-- Additional CSS for the specific page -->
<style>
    /* Your specific page CSS styles */
</style>
{% endblock %}

{% block javascript %}
<!-- Include external JavaScript libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.0/dist/jsQR.min.js"></script>
<script>
    let scanner = new Instascan.Scanner({ video: document.getElementById('scanner') });
    scanner.addListener('scan', function (content) {
        handleQRCode(content);
    });

    Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
            scanner.start(cameras[0]);
        } else {
            console.error('No cameras found.');
        }
    }).catch(function (e) {
        console.error(e);
    });

    async function handleQRCode(content) {
        let pattern = /^[a-zA-Z]+ [a-zA-Z]+ \| \d{4}-\d{2}-\d{2}$/;
        if (pattern.test(content)) {
            // Extract user information and submit the form
            let userInfo = content.split(' | ');

            // Check if the date from the QR code is the current date
            let qrDate = new Date(userInfo[1]);
            let currentDate = new Date();

            if (qrDate.toISOString().split('T')[0] === currentDate.toISOString().split('T')[0]) {
                // Get user's current location using OpenStreetMap Nominatim reverse geocoding API
                try {
                    navigator.geolocation.getCurrentPosition(async function (position) {
                        let latitude = position.coords.latitude;
                        let longitude = position.coords.longitude;

                        let response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
                        let data = await response.json();

                        if (data && data.address) {
                            // Display the full address in the input
                            let fullAddress = data.display_name;
                            document.getElementById('location').value = fullAddress;

                            // Extract city from the address
                            let city = data.address.city || data.address.town || data.address.village;

                            // Update form fields with retrieved values
                            document.getElementById('latitude').value = latitude.toFixed(6);
                            document.getElementById('longitude').value = parseFloat(longitude).toPrecision(9);
                            document.getElementById('date').value = userInfo[1];

                            // Format the time as HH:MM:ss
                            let formattedTime = `${String(currentDate.getHours()).padStart(2, '0')}:${String(currentDate.getMinutes()).padStart(2, '0')}:${String(currentDate.getSeconds()).padStart(2, '0')}`;

                            // Check if time_in is already set
                            let timeInField = document.getElementById('time_in');
                            if (timeInField.value.trim() === "") {
                                // If time_in is not set, set it now
                                timeInField.value = formattedTime;
                            } else {
                                // If time_in is already set, set time_out
                                document.getElementById('time_out').value = formattedTime;

                                // Submit the form
                                document.getElementById('locationForm').submit();
                            }

                            document.getElementById('qrCode').value = content;
                        }
                    });
                } catch (error) {
                    console.error('Error fetching location:', error);
                }
            } else {
                alert('QR Code is invalid.');
            }
        } else {
            alert('Invalid QR Code format.');
        }
    }

    // Alert Message Scripts
    $(document).ready(function () {
      {% if messages %}
          {% for message in messages %}
              {% if message.tags == 'success' %}
                  toastr.success('{{ message }}');
              {% elif message.tags == 'error' %}
                  toastr.error('{{ message }}');
              {% else %}
                  toastr('{{ message }}');
              {% endif %}
          {% endfor %}
      {% endif %}
  });
</script>
<!-- Additional JavaScript for the specific page -->

{% endblock %}
{% endblock %}