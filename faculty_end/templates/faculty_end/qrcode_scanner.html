{% extends 'faculty_end/base.html' %}
{% load static %}
{% block content %}

<!-- Page header -->
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    QR Code Scanner
                </h2>
            </div>
        </div>
    </div>
</div>
<!-- Page body -->
<div class="page-body">
    <div class="container-xl">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Scan Your QR Code</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="embed-responsive embed-responsive-16by9">
                            <video id="scanner" class="embed-responsive-item w-100" playsinline></video>
                        </div>
                    </div>
                </div>
                <div class="mb-1">
                    <form id="locationForm" method="post" action="{% url 'save_attendance' %}">
                        {% csrf_token %}
                        <div class="form-floating mb-1">
                            <input name="location" type="text" class="form-control" id="location" value="" readonly>
                            <label for="location">Location</label>
                        </div>
                        <div class="form-floating mb-1">
                            <input name="latitude" type="text" class="form-control" id="latitude" value="" readonly>
                            <label for="latitude">Latitude</label>
                        </div>
                        <div class="form-floating mb-1">
                            <input name="longitude" type="text" class="form-control" id="longitude" value="" readonly>
                            <label for="longitude">Longitude</label>
                        </div>
                        <div class="form-floating mb-1">
                            <input name="date" type="date" class="form-control" id="date" value="" readonly>
                            <label for="date">Date</label>
                        </div>
                        <div class="form-floating mb-1">
                            <input name="time_in" type="text" class="form-control" id="time_in" value="" readonly>
                            <label for="time">Time</label>
                        </div>
                        <div class="form-floating mb-1">
                            <input name="time_out" type="text" class="form-control" id="time_out" value="" readonly>
                            <label for="time">Time</label>
                        </div>
                        <input type="hidden" id="qrCode" name="qrCode" value="">
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% block css %}
<!-- Include external CSS stylesheets -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<!-- Additional CSS for the specific page -->
<style>
    /* Your specific page CSS styles */
</style>
{% endblock %}

{% block javascript %}
<!-- Include external JavaScript libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.0/dist/jsQR.min.js"></script>
<script>
    let scanner = new Instascan.Scanner({ video: document.getElementById('scanner') });
    scanner.addListener('scan', function (content) {
        handleQRCode(content);
    });

    Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
            scanner.start(cameras[0]);
        } else {
            console.error('No cameras found.');
        }
    }).catch(function (e) {
        console.error(e);
    });

    async function handleQRCode(content) {
        let pattern = /^[a-zA-Z]+ [a-zA-Z]+ \| \d{4}-\d{2}-\d{2}$/;
        if (pattern.test(content)) {
            // Extract user information and submit the form
            let userInfo = content.split(' | ');
    
            // Get user's current location using OpenStreetMap Nominatim reverse geocoding API
            try {
                navigator.geolocation.getCurrentPosition(async function (position) {
                    let latitude = position.coords.latitude;
                    let longitude = position.coords.longitude;
    
                    let response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
                    let data = await response.json();
    
                    if (data && data.address) {
                        // Extract city from the address
                        let city = data.address.city || data.address.town || data.address.village;
    
                        // Update form fields with retrieved values
                        document.getElementById('location').value = city;
                        document.getElementById('latitude').value = latitude.toFixed(6);
                        document.getElementById('longitude').value = parseFloat(longitude).toPrecision(9);
                        let localDate = new Date();
                        document.getElementById('date').value = userInfo[1];
    
                        // Format the time as HH:MM:ss
                        let formattedTime = `${String(localDate.getHours()).padStart(2, '0')}:${String(localDate.getMinutes()).padStart(2, '0')}:${String(localDate.getSeconds()).padStart(2, '0')}`;
                        
                        // Check if time_in is already set
                        let timeInField = document.getElementById('time_in');
                        if (timeInField.value.trim() === "") {
                            // If time_in is not set, set it now
                            timeInField.value = formattedTime;
                        } else {
                            // If time_in is already set, set time_out
                            document.getElementById('time_out').value = formattedTime;
    
                            // Submit the form
                            document.getElementById('locationForm').submit();
                        }
    
                        document.getElementById('qrCode').value = content;
                    }
                });
            } catch (error) {
                console.error('Error fetching location:', error);
            }
        } else {
            alert('Invalid QR Code format.');
        }
    }

    {% comment %} Alert Message Scripts {% endcomment %}
    $(document).ready(function () {
        {% if messages %}
        {% for message in messages %}
        {% if message.tags == 'success' %}
        toastr.success('{{ message }}');
        {% elif message.tags == 'error' %}
        toastr.error('{{ message }}');
        {% else %}
        toastr('{{ message }}');
        {% endif %}
        {% endfor %}
        {% endif %}
    });
</script>
<!-- Additional JavaScript for the specific page -->
{% endblock %}
{% endblock %}